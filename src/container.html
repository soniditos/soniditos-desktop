<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soniditos Desktop</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            background-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        /* Contenedor principal */
        .app-container {
            width: 100vw;
            height: 100vh;
            background: #121212;
            overflow: hidden;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        /* Barra de título personalizada estilo Photon */
        .custom-titlebar {
            height: 40px;
            background: linear-gradient(135deg, #2d2d30 0%, #252526 100%);
            border-bottom: 1px solid #1e1e1e;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0 20px;
            color: #cccccc;
            font-size: 14px;
            font-weight: 500;
            -webkit-app-region: drag;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        /* Controles de ventana estilo Photon (macOS) */
        .window-controls {
            display: flex;
            gap: 8px;
            -webkit-app-region: no-drag;
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        .window-control {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 0.5px solid rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .window-control:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .control-close { 
            background: linear-gradient(135deg, #ff5f57 0%, #ff4444 100%);
        }
        .control-minimize { 
            background: linear-gradient(135deg, #ffbd2e 0%, #ffaa00 100%);
        }
        .control-maximize { 
            background: linear-gradient(135deg, #28ca42 0%, #20aa30 100%);
        }

        /* Contenedor del iframe */
        .content-container {
            flex: 1;
            background: #121212;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Webview que contiene la web */
        .web-view {
            width: 100%;
            height: 100%;
            border: none;
            background: #121212;
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Barra de título personalizada estilo Photon -->
        <div class="custom-titlebar">
            <!-- Solo controles de ventana -->
            <div class="window-controls">
                <div class="window-control control-close" onclick="closeWindow()"></div>
                <div class="window-control control-minimize" onclick="minimizeWindow()"></div>
                <div class="window-control control-maximize" onclick="maximizeWindow()"></div>
            </div>
        </div>

        <!-- Contenedor del contenido web -->
        <div class="content-container">
            <!-- Webview que contiene la web -->
            <webview 
                class="web-view" 
                id="webView"
                src="https://open.soniditos.com"
                allowpopups="true"
                autosize="on"
                partition="persist:soniditos"
                webpreferences="allowRunningInsecureContent, javascript=yes">
            </webview>
        </div>
    </div>

    <script>
        // Funciones para los controles de ventana
        function closeWindow() {
            if (window.electronAPI) {
                window.electronAPI.closeWindow();
            }
        }

        function minimizeWindow() {
            if (window.electronAPI) {
                window.electronAPI.minimizeWindow();
            }
        }

        function maximizeWindow() {
            if (window.electronAPI) {
                window.electronAPI.maximizeWindow();
            }
        }

        // Configuración del webview cuando esté listo
        document.addEventListener('DOMContentLoaded', function() {
            const webview = document.getElementById('webView');

            function sendMetadataToMain(metadata) {
                if (window.mediaAPI && metadata) {
                    window.mediaAPI.sendMediaMetadata(metadata);
                }
            }

            webview.addEventListener('dom-ready', function() {
                // Inyectar script en el webview para observar cambios en mediaSession
                webview.executeJavaScript(`
                    function sendMetadata() {
                        const meta = navigator.mediaSession?.metadata;
                        if (meta) {
                            const data = {
                                title: meta.title || null,
                                artist: meta.artist || null,
                                album: meta.album || null,
                                artwork: (meta.artwork && meta.artwork[0] && meta.artwork[0].src) || null,
                                cuedMediaId: localStorage.getItem('player.web-player.cuedMediaId') || null,
                                startTime: (document.querySelector('div.text-xs.text-muted.flex-shrink-0.min-w-40.text-right span')?.textContent || null)
                            };
                            window.postMessage({ type: 'MEDIA_METADATA', data }, '*');
                        }
                    }
                    if ('mediaSession' in navigator) {
                        navigator.mediaSession.setActionHandler('play', sendMetadata);
                        navigator.mediaSession.setActionHandler('pause', sendMetadata);
                        navigator.mediaSession.setActionHandler('seekto', sendMetadata);
                        setInterval(sendMetadata, 1000);
                    }
                `);
            });

            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'MEDIA_METADATA') {
                    sendMetadataToMain(event.data.data);
                }
            });

            // ...eventos originales...
            webview.addEventListener('page-title-updated', function(event) {
                console.log('Título de página actualizado:', event.title);
            });
            webview.addEventListener('did-start-loading', function() {
                console.log('Comenzando a cargar...');
            });
            webview.addEventListener('did-stop-loading', function() {
                console.log('Carga completada');
            });
            webview.addEventListener('did-fail-load', function(event) {
                console.error('Error al cargar:', event.errorDescription);
            });
            webview.addEventListener('new-window', function(event) {
                console.log('Nueva ventana solicitada:', event.url);
                event.preventDefault();
                webview.src = event.url;
            });
        });
    </script>
</body>
</html>
